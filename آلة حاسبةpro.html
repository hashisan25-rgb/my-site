<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آلة حاسبة متطورة - Calculator Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4361ee">
    <style>
        /* إعدادات متقدمة */
        :root {
            /* الألوان الأساسية */
            --primary-color: #4361ee;
            --primary-dark: #3a0ca3;
            --secondary-color: #4cc9f0;
            --accent-color: #f72585;
            --success-color: #2ecc71;
            --warning-color: #e74c3c;
            --info-color: #3498db;
            
            /* السمة الفاتحة */
            --light-bg: #f8f9fa;
            --light-card: #ffffff;
            --light-text: #212529;
            --light-border: #dee2e6;
            --light-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            
            /* السمة الداكنة */
            --dark-bg: #0d1117;
            --dark-card: #161b22;
            --dark-text: #f0f6fc;
            --dark-border: #30363d;
            --dark-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            
            /* التدرجات */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color), #2d9cdb);
            --gradient-accent: linear-gradient(135deg, var(--accent-color), #b5179e);
            
            /* الظلال والزوايا */
            --radius-xl: 25px;
            --radius-lg: 20px;
            --radius-md: 15px;
            --radius-sm: 10px;
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 5px 15px rgba(0, 0, 0, 0.05);
            
            /* الحركات */
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* إعدادات عامة */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Cairo', sans-serif;
            background: var(--light-bg);
            color: var(--light-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: var(--transition-normal);
            overflow-x: hidden;
        }

        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        body.gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
        }

        body.gradient-bg.dark-mode {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            background-attachment: fixed;
        }

        /* شريط التحميل */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: var(--gradient-primary);
            z-index: 10000;
            transition: width 0.3s ease;
        }

        /* شريط التنقل العلوي */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--light-border);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: var(--transition-normal);
        }

        .dark-mode .nav-bar {
            background: rgba(22, 27, 34, 0.95);
            border-color: var(--dark-border);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .app-title {
            font-size: 1.3rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-menu {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 1rem;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dark-mode .nav-btn {
            color: var(--dark-text);
        }

        .nav-btn:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
        }

        .nav-right {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition-fast);
        }

        .icon-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            transform: scale(1.1);
        }

        /* المحتوى الرئيسي */
        .main-content {
            margin-top: 70px;
            flex: 1;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        /* شاشة الآلة الحاسبة */
        .calculator-section {
            display: none;
        }

        .calculator-section.active {
            display: block;
        }

        .calculator-container {
            background: var(--light-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: var(--transition-normal);
            margin-bottom: 30px;
        }

        .dark-mode .calculator-container {
            background: var(--dark-card);
        }

        .calculator-header {
            padding: 25px 30px;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calculator-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .calculator-modes {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.9rem;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary-color);
        }

        .mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.3);
        }

        /* شاشة العرض */
        .display-container {
            padding: 30px;
            position: relative;
        }

        .display-wrapper {
            background: var(--light-bg);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: var(--transition-normal);
        }

        .dark-mode .display-wrapper {
            background: var(--dark-bg);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .expression-display {
            font-size: 1.2rem;
            color: #666;
            min-height: 30px;
            word-break: break-all;
            text-align: left;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .dark-mode .expression-display {
            color: #aaa;
        }

        .result-display {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--primary-color);
            word-break: break-all;
            text-align: left;
            min-height: 70px;
            line-height: 1.2;
            font-family: 'Courier New', monospace;
        }

        /* معلومات الحساب */
        .calculation-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-border);
        }

        .dark-mode .calculation-info {
            border-color: var(--dark-border);
        }

        .memory-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--info-color);
        }

        .calculation-time {
            font-size: 0.85rem;
            color: #666;
        }

        .dark-mode .calculation-time {
            color: #aaa;
        }

        /* لوحة الأزرار */
        .buttons-panel {
            padding: 0 30px 30px;
        }

        .buttons-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 12px 25px;
            background: var(--light-bg);
            border: none;
            border-radius: var(--radius-md);
            color: var(--light-text);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .dark-mode .tab-btn {
            background: var(--dark-border);
            color: var(--dark-text);
        }

        .tab-btn.active {
            background: var(--gradient-primary);
            color: white;
        }

        .buttons-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* أزرار الآلة الحاسبة العادية */
        .calculator-grid {
            grid-template-columns: repeat(5, 1fr);
        }

        /* أزرار الآلة الحاسبة العلمية */
        .scientific-grid {
            grid-template-columns: repeat(8, 1fr);
            display: none;
        }

        .scientific-grid.active {
            display: grid;
        }

        /* أزرار الآلة الحاسبة المبرمجة */
        .programmer-grid {
            grid-template-columns: repeat(6, 1fr);
            display: none;
        }

        .programmer-grid.active {
            display: grid;
        }

        /* أنواع الأزرار */
        .calc-btn {
            padding: 20px 10px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 70px;
        }

        .calc-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .calc-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-number {
            background: var(--light-card);
            color: var(--light-text);
            box-shadow: var(--shadow-sm);
        }

        .dark-mode .btn-number {
            background: var(--dark-card);
            color: var(--dark-text);
        }

        .btn-number:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .btn-operator {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-operator:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(67, 97, 238, 0.3);
        }

        .btn-function {
            background: var(--gradient-secondary);
            color: white;
            box-shadow: var(--shadow-md);
            font-size: 1.1rem;
        }

        .btn-function:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(76, 201, 240, 0.3);
        }

        .btn-special {
            background: var(--gradient-accent);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-special:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(247, 37, 133, 0.3);
        }

        .btn-equals {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            color: white;
            font-size: 1.8rem;
            box-shadow: var(--shadow-md);
            grid-column: span 2;
        }

        .btn-equals:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(46, 204, 113, 0.3);
        }

        .btn-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
            font-weight: normal;
        }

        /* لوحة التحويل */
        .converter-section {
            display: none;
        }

        .converter-section.active {
            display: block;
        }

        .converter-container {
            background: var(--light-card);
            border-radius: var(--radius-xl);
            padding: 30px;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-normal);
        }

        .dark-mode .converter-container {
            background: var(--dark-card);
        }

        .converter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .converter-type {
            padding: 15px 25px;
            background: var(--light-bg);
            border: none;
            border-radius: var(--radius-md);
            color: var(--light-text);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 1rem;
            font-weight: 500;
        }

        .dark-mode .converter-type {
            background: var(--dark-border);
        }

        .converter-type.active {
            background: var(--gradient-primary);
            color: white;
        }

        .converter-content {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: center;
        }

        .conversion-box {
            background: var(--light-bg);
            border-radius: var(--radius-lg);
            padding: 25px;
            transition: var(--transition-normal);
        }

        .dark-mode .conversion-box {
            background: var(--dark-bg);
        }

        .conversion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .conversion-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .unit-select {
            padding: 10px 15px;
            background: var(--light-card);
            border: 2px solid var(--light-border);
            border-radius: var(--radius-md);
            color: var(--light-text);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
            min-width: 150px;
        }

        .dark-mode .unit-select {
            background: var(--dark-card);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }

        .unit-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .conversion-input {
            width: 100%;
            padding: 20px;
            font-size: 2.5rem;
            background: transparent;
            border: none;
            color: var(--light-text);
            text-align: right;
            direction: ltr;
        }

        .dark-mode .conversion-input {
            color: var(--dark-text);
        }

        .conversion-input:focus {
            outline: none;
        }

        .swap-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swap-btn:hover {
            transform: rotate(180deg) scale(1.1);
        }

        /* لوحة الرسوم البيانية */
        .graph-section {
            display: none;
        }

        .graph-section.active {
            display: block;
        }

        .graph-container {
            background: var(--light-card);
            border-radius: var(--radius-xl);
            padding: 30px;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-normal);
        }

        .dark-mode .graph-container {
            background: var(--dark-card);
        }

        .graph-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .graph-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .graph-input-group label {
            font-weight: 500;
            color: var(--primary-color);
        }

        .graph-input {
            padding: 15px;
            background: var(--light-bg);
            border: 2px solid var(--light-border);
            border-radius: var(--radius-md);
            color: var(--light-text);
            font-size: 1rem;
            transition: var(--transition-fast);
        }

        .dark-mode .graph-input {
            background: var(--dark-bg);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }

        .graph-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .graph-canvas-container {
            background: var(--light-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode .graph-canvas-container {
            background: var(--dark-bg);
        }

        #graphCanvas {
            width: 100%;
            height: 400px;
            background: var(--light-card);
            border-radius: var(--radius-md);
        }

        .dark-mode #graphCanvas {
            background: var(--dark-card);
        }

        /* لوحة الإعدادات */
        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-container {
            background: var(--light-card);
            border-radius: var(--radius-xl);
            padding: 30px;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-normal);
        }

        .dark-mode .settings-container {
            background: var(--dark-card);
        }

        .settings-group {
            margin-bottom: 40px;
        }

        .settings-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-border);
        }

        .dark-mode .settings-title {
            border-color: var(--dark-border);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--light-bg);
            border-radius: var(--radius-lg);
            transition: var(--transition-fast);
        }

        .dark-mode .setting-item {
            background: var(--dark-bg);
        }

        .setting-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .setting-label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .setting-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .dark-mode .setting-desc {
            color: #aaa;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* عناصر التحكم في الإعدادات */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: var(--transition-normal);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: var(--transition-normal);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid var(--light-border);
            cursor: pointer;
            padding: 0;
            overflow: hidden;
        }

        .dark-mode .color-picker {
            border-color: var(--dark-border);
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
            padding: 0;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .range-slider {
            width: 200px;
            height: 8px;
            -webkit-appearance: none;
            background: var(--light-border);
            border-radius: 4px;
            outline: none;
        }

        .dark-mode .range-slider {
            background: var(--dark-border);
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* النوافذ المنبثقة */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--light-card);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
        }

        .dark-mode .modal {
            background: var(--dark-card);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 25px 30px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
            border-radius: 50%;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        /* الرسائل العائمة */
        .notification {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: var(--light-card);
            border-radius: var(--radius-lg);
            padding: 20px 25px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(-100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1500;
            max-width: 400px;
        }

        .dark-mode .notification {
            background: var(--dark-card);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .notification-success .notification-icon {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .notification-warning .notification-icon {
            background: rgba(231, 76, 60, 0.1);
            color: var(--warning-color);
        }

        .notification-info .notification-icon {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 0.9rem;
            color: #666;
        }

        .dark-mode .notification-message {
            color: #aaa;
        }

        .notification-close {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition-fast);
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .dark-mode .notification-close {
            color: #aaa;
        }

        .dark-mode .notification-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* الفوتر */
        .footer {
            margin-top: 40px;
            text-align: center;
            padding: 25px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid var(--light-border);
        }

        .dark-mode .footer {
            color: #aaa;
            border-color: var(--dark-border);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .footer-link:hover {
            text-decoration: underline;
            transform: translateY(-2px);
        }

        /* التجاوب مع الشاشات */
        @media (max-width: 1200px) {
            .scientific-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 992px) {
            .calculator-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .scientific-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .programmer-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .converter-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .swap-btn {
                margin: 0 auto;
            }
        }

        @media (max-width: 768px) {
            .nav-bar {
                padding: 12px 15px;
            }
            
            .nav-menu {
                gap: 10px;
            }
            
            .nav-btn {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            
            .calculator-header {
                padding: 20px;
            }
            
            .display-container {
                padding: 20px;
            }
            
            .result-display {
                font-size: 2.8rem;
            }
            
            .calc-btn {
                padding: 18px 8px;
                font-size: 1.1rem;
                min-height: 60px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .main-content {
                margin-top: 60px;
            }
            
            .nav-left {
                gap: 10px;
            }
            
            .app-title {
                font-size: 1.1rem;
            }
            
            .nav-menu {
                display: none;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .calculator-grid,
            .scientific-grid,
            .programmer-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .btn-equals {
                grid-column: span 3;
            }
            
            .buttons-tabs,
            .converter-tabs {
                font-size: 0.8rem;
            }
            
            .tab-btn,
            .converter-type {
                padding: 10px 15px;
            }
            
            .result-display {
                font-size: 2.2rem;
            }
        }

        /* شريط القائمة الجانبية للموبايل */
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: var(--light-card);
            box-shadow: var(--shadow-lg);
            z-index: 2001;
            transition: var(--transition-normal);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .dark-mode .mobile-menu {
            background: var(--dark-card);
        }

        .mobile-menu.active {
            right: 0;
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--light-border);
        }

        .dark-mode .mobile-menu-header {
            border-color: var(--dark-border);
        }

        .mobile-menu-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .mobile-menu-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--light-text);
            cursor: pointer;
        }

        .dark-mode .mobile-menu-close {
            color: var(--dark-text);
        }

        .mobile-menu-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mobile-menu-item {
            padding: 15px;
            border-radius: var(--radius-md);
            background: var(--light-bg);
            border: none;
            color: var(--light-text);
            font-size: 1rem;
            text-align: right;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .dark-mode .mobile-menu-item {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        .mobile-menu-item:hover,
        .mobile-menu-item.active {
            background: var(--gradient-primary);
            color: white;
        }

        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 2000;
            display: none;
        }

        .mobile-menu-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- شريط التحميل -->
    <div class="progress-bar" id="progressBar"></div>

    <!-- شريط التنقل العلوي -->
    <nav class="nav-bar">
        <div class="nav-left">
            <button class="icon-btn mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="app-title">حاسبة Pro</h1>
            <div class="nav-menu">
                <button class="nav-btn active" data-section="calculator">
                    <i class="fas fa-calculator"></i>
                    <span>آلة حاسبة</span>
                </button>
                <button class="nav-btn" data-section="converter">
                    <i class="fas fa-exchange-alt"></i>
                    <span>محول الوحدات</span>
                </button>
                <button class="nav-btn" data-section="graph">
                    <i class="fas fa-chart-line"></i>
                    <span>الرسوم البيانية</span>
                </button>
                <button class="nav-btn" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </button>
            </div>
        </div>
        
        <div class="nav-right">
            <button class="icon-btn" id="historyBtn" title="السجل">
                <i class="fas fa-history"></i>
            </button>
            <button class="icon-btn" id="themeToggle" title="تبديل السمة">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
            <button class="icon-btn" id="helpBtn" title="المساعدة">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
    </nav>

    <!-- القائمة الجانبية للموبايل -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <h2 class="mobile-menu-title">القائمة</h2>
            <button class="mobile-menu-close" id="mobileMenuClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mobile-menu-items">
            <button class="mobile-menu-item active" data-section="calculator">
                <i class="fas fa-calculator"></i>
                <span>آلة حاسبة</span>
            </button>
            <button class="mobile-menu-item" data-section="converter">
                <i class="fas fa-exchange-alt"></i>
                <span>محول الوحدات</span>
            </button>
            <button class="mobile-menu-item" data-section="graph">
                <i class="fas fa-chart-line"></i>
                <span>الرسوم البيانية</span>
            </button>
            <button class="mobile-menu-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>الإعدادات</span>
            </button>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <main class="main-content">
        <!-- قسم الآلة الحاسبة -->
        <section class="calculator-section active" id="calculatorSection">
            <div class="calculator-container">
                <div class="calculator-header">
                    <h2 class="calculator-title">آلة حاسبة متطورة</h2>
                    <div class="calculator-modes">
                        <button class="mode-btn active" data-mode="basic">عادي</button>
                        <button class="mode-btn" data-mode="scientific">علمي</button>
                        <button class="mode-btn" data-mode="programmer">مبرمج</button>
                    </div>
                </div>

                <div class="display-container">
                    <div class="display-wrapper">
                        <div class="expression-display" id="expressionDisplay"></div>
                        <div class="result-display" id="resultDisplay">0</div>
                    </div>
                    <div class="calculation-info">
                        <div class="memory-indicator" id="memoryIndicator">
                            <i class="fas fa-memory"></i>
                            <span id="memoryValue">0</span>
                        </div>
                        <div class="calculation-time" id="calculationTime"></div>
                    </div>
                </div>

                <div class="buttons-panel">
                    <div class="buttons-tabs">
                        <button class="tab-btn active" data-tab="basic">أساسي</button>
                        <button class="tab-btn" data-tab="trigonometry">مثلثات</button>
                        <button class="tab-btn" data-tab="algebra">جبر</button>
                        <button class="tab-btn" data-tab="constants">ثوابت</button>
                        <button class="tab-btn" data-tab="memory">الذاكرة</button>
                    </div>

                    <!-- لوحة الأزرار الأساسية -->
                    <div class="buttons-grid calculator-grid active">
                        <!-- سيتم إنشاء الأزرار ديناميكياً -->
                    </div>

                    <!-- لوحة الأزرار العلمية -->
                    <div class="buttons-grid scientific-grid">
                        <!-- سيتم إنشاء الأزرار ديناميكياً -->
                    </div>

                    <!-- لوحة الأزرار للمبرمج -->
                    <div class="buttons-grid programmer-grid">
                        <!-- سيتم إنشاء الأزرار ديناميكياً -->
                    </div>
                </div>
            </div>
        </section>

        <!-- قسم محول الوحدات -->
        <section class="converter-section" id="converterSection">
            <div class="converter-container">
                <div class="converter-tabs">
                    <button class="converter-type active" data-type="length">الطول</button>
                    <button class="converter-type" data-type="weight">الوزن</button>
                    <button class="converter-type" data-type="temperature">درجة الحرارة</button>
                    <button class="converter-type" data-type="currency">العملة</button>
                    <button class="converter-type" data-type="area">المساحة</button>
                    <button class="converter-type" data-type="volume">الحجم</button>
                    <button class="converter-type" data-type="time">الوقت</button>
                    <button class="converter-type" data-type="speed">السرعة</button>
                </div>

                <div class="converter-content">
                    <div class="conversion-box" id="fromBox">
                        <div class="conversion-header">
                            <h3 class="conversion-title">من</h3>
                            <select class="unit-select" id="fromUnit"></select>
                        </div>
                        <input type="text" class="conversion-input" id="fromInput" value="1">
                    </div>

                    <button class="swap-btn" id="swapUnits">
                        <i class="fas fa-exchange-alt"></i>
                    </button>

                    <div class="conversion-box" id="toBox">
                        <div class="conversion-header">
                            <h3 class="conversion-title">إلى</h3>
                            <select class="unit-select" id="toUnit"></select>
                        </div>
                        <input type="text" class="conversion-input" id="toInput" readonly>
                    </div>
                </div>
            </div>
        </section>

        <!-- قسم الرسوم البيانية -->
        <section class="graph-section" id="graphSection">
            <div class="graph-container">
                <div class="graph-controls">
                    <div class="graph-input-group">
                        <label for="functionInput">الدالة الرياضية (استخدم x كمتغير)</label>
                        <input type="text" class="graph-input" id="functionInput" value="sin(x)" placeholder="مثال: sin(x), x^2, log(x)">
                    </div>
                    <div class="graph-input-group">
                        <label for="xMin">الحد الأدنى لـ x</label>
                        <input type="number" class="graph-input" id="xMin" value="-10" step="0.1">
                    </div>
                    <div class="graph-input-group">
                        <label for="xMax">الحد الأقصى لـ x</label>
                        <input type="number" class="graph-input" id="xMax" value="10" step="0.1">
                    </div>
                    <div class="graph-input-group">
                        <label for="yMin">الحد الأدنى لـ y</label>
                        <input type="number" class="graph-input" id="yMin" value="-10" step="0.1">
                    </div>
                    <div class="graph-input-group">
                        <label for="yMax">الحد الأقصى لـ y</label>
                        <input type="number" class="graph-input" id="yMax" value="10" step="0.1">
                    </div>
                </div>

                <div class="graph-canvas-container">
                    <canvas id="graphCanvas"></canvas>
                </div>
            </div>
        </section>

        <!-- قسم الإعدادات -->
        <section class="settings-section" id="settingsSection">
            <div class="settings-container">
                <div class="settings-group">
                    <h3 class="settings-title">المظهر</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">الوضع الداكن</span>
                                <span class="setting-desc">تفعيل السمة الداكنة</span>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="darkModeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">خلفية متدرجة</span>
                                <span class="setting-desc">تفعيل الخلفية المتدرجة</span>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="gradientBgToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">لون المظهر</span>
                                <span class="setting-desc">تغيير اللون الرئيسي</span>
                            </div>
                            <div class="setting-control">
                                <input type="color" class="color-picker" id="primaryColorPicker" value="#4361ee">
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">حجم الخط</span>
                                <span class="setting-desc">تغيير حجم النص</span>
                            </div>
                            <div class="setting-control">
                                <input type="range" class="range-slider" id="fontSizeSlider" min="14" max="20" value="16">
                                <span id="fontSizeValue">16px</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <h3 class="settings-title">الآلة الحاسبة</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">التنبيهات الصوتية</span>
                                <span class="setting-desc">أصوات عند النقر على الأزرار</span>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="soundToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">الاهتزاز</span>
                                <span class="setting-desc">اهتزاز عند النقر</span>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="vibrationToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">التنسيق التلقائي</span>
                                <span class="setting-desc">تنسيق الأرقام تلقائياً</span>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoFormatToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">الدقة العشرية</span>
                                <span class="setting-desc">عدد الأرقام بعد الفاصلة</span>
                            </div>
                            <div class="setting-control">
                                <input type="range" class="range-slider" id="decimalSlider" min="0" max="10" value="2">
                                <span id="decimalValue">2</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <h3 class="settings-title">عام</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">اللغة</span>
                                <span class="setting-desc">لغة الواجهة</span>
                            </div>
                            <div class="setting-control">
                                <select class="unit-select" id="languageSelect">
                                    <option value="ar">العربية</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">نسخ احتياطي</span>
                                <span class="setting-desc">نسخ الإعدادات والبيانات</span>
                            </div>
                            <div class="setting-control">
                                <button class="icon-btn" id="backupBtn">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="icon-btn" id="restoreBtn">
                                    <i class="fas fa-upload"></i>
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span class="setting-name">إعادة التعيين</span>
                                <span class="setting-desc">إعادة ضبط كل الإعدادات</span>
                            </div>
                            <div class="setting-control">
                                <button class="icon-btn" id="resetBtn" style="background: var(--warning-color); color: white;">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- الفوتر -->
    <footer class="footer">
        <div class="footer-links">
            <a href="#" class="footer-link" onclick="showAbout()">عن التطبيق</a>
            <a href="#" class="footer-link" onclick="showPrivacy()">سياسة الخصوصية</a>
            <a href="#" class="footer-link" onclick="showTerms()">الشروط والأحكام</a>
            <a href="#" class="footer-link" onclick="showFeedback()">تقييم التطبيق</a>
        </div>
        <p>© 2026 آلة حاسبة Pro. جميع الحقوق محفوظة. الإصدار 3.0</p>
    </footer>

    <!-- النوافذ المنبثقة -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">سجل العمليات</h3>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body" id="historyModalBody">
                <!-- محتوى السجل -->
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">دليل الاستخدام</h3>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-body" id="helpModalBody">
                <!-- محتوى المساعدة -->
            </div>
        </div>
    </div>

    <!-- الرسائل العائمة -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle"></div>
            <div class="notification-message" id="notificationMessage"></div>
        </div>
        <button class="notification-close" onclick="closeNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
        // ==================== المتغيرات العامة ====================
        let calculatorState = {
            currentValue: '0',
            previousValue: '',
            operation: null,
            waitingForNewValue: false,
            memory: 0,
            history: [],
            isScientific: false,
            isProgrammer: false,
            currentMode: 'basic',
            currentTab: 'basic',
            settings: {
                darkMode: false,
                gradientBg: false,
                primaryColor: '#4361ee',
                soundEnabled: true,
                vibrationEnabled: false,
                autoFormat: true,
                decimalPlaces: 2,
                language: 'ar',
                fontSize: 16
            }
        };

        // ==================== تهيئة التطبيق ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            initCalculator();
            initConverter();
            initGraph();
            initSettings();
            setupEventListeners();
            showNotification('مرحباً!', 'تم تحميل التطبيق بنجاح', 'success');
        });

        // ==================== الآلة الحاسبة ====================
        function initCalculator() {
            createCalculatorButtons();
            updateDisplay();
            loadHistory();
        }

        function createCalculatorButtons() {
            // الأزرار الأساسية
            const basicButtons = [
                { label: 'C', action: 'clear', class: 'btn-special', colSpan: 1 },
                { label: '⌫', action: 'backspace', class: 'btn-special', colSpan: 1 },
                { label: '%', action: 'percentage', class: 'btn-function', colSpan: 1 },
                { label: '÷', action: '/', class: 'btn-operator', colSpan: 1 },
                { label: '7', action: '7', class: 'btn-number', colSpan: 1 },
                { label: '8', action: '8', class: 'btn-number', colSpan: 1 },
                { label: '9', action: '9', class: 'btn-number', colSpan: 1 },
                { label: '×', action: '*', class: 'btn-operator', colSpan: 1 },
                { label: '4', action: '4', class: 'btn-number', colSpan: 1 },
                { label: '5', action: '5', class: 'btn-number', colSpan: 1 },
                { label: '6', action: '6', class: 'btn-number', colSpan: 1 },
                { label: '−', action: '-', class: 'btn-operator', colSpan: 1 },
                { label: '1', action: '1', class: 'btn-number', colSpan: 1 },
                { label: '2', action: '2', class: 'btn-number', colSpan: 1 },
                { label: '3', action: '3', class: 'btn-number', colSpan: 1 },
                { label: '+', action: '+', class: 'btn-operator', colSpan: 1 },
                { label: '±', action: 'toggleSign', class: 'btn-function', colSpan: 1 },
                { label: '0', action: '0', class: 'btn-number', colSpan: 1 },
                { label: '.', action: '.', class: 'btn-function', colSpan: 1 },
                { label: '=', action: '=', class: 'btn-equals', colSpan: 2 }
            ];

            // الأزرار العلمية
            const scientificButtons = [
                { label: 'sin', action: 'sin', class: 'btn-function', subLabel: 'sin(x)' },
                { label: 'cos', action: 'cos', class: 'btn-function', subLabel: 'cos(x)' },
                { label: 'tan', action: 'tan', class: 'btn-function', subLabel: 'tan(x)' },
                { label: 'log', action: 'log', class: 'btn-function', subLabel: 'log₁₀(x)' },
                { label: 'ln', action: 'ln', class: 'btn-function', subLabel: 'ln(x)' },
                { label: 'x²', action: 'square', class: 'btn-function', subLabel: 'x²' },
                { label: 'x³', action: 'cube', class: 'btn-function', subLabel: 'x³' },
                { label: '√', action: 'sqrt', class: 'btn-function', subLabel: '√x' },
                { label: '∛', action: 'cbrt', class: 'btn-function', subLabel: '∛x' },
                { label: 'xʸ', action: 'power', class: 'btn-function', subLabel: 'xʸ' },
                { label: 'eˣ', action: 'exp', class: 'btn-function', subLabel: 'eˣ' },
                { label: '10ˣ', action: 'tenPower', class: 'btn-function', subLabel: '10ˣ' },
                { label: '1/x', action: 'reciprocal', class: 'btn-function', subLabel: '1/x' },
                { label: 'x!', action: 'factorial', class: 'btn-function', subLabel: 'x!' },
                { label: 'π', action: 'pi', class: 'btn-function', subLabel: 'π' },
                { label: 'e', action: 'euler', class: 'btn-function', subLabel: 'e' },
                { label: '(', action: '(', class: 'btn-function', subLabel: '(' },
                { label: ')', action: ')', class: 'btn-function', subLabel: ')' },
                { label: '|x|', action: 'abs', class: 'btn-function', subLabel: '|x|' },
                { label: 'mod', action: 'mod', class: 'btn-function', subLabel: 'mod' }
            ];

            // أزرار المبرمج
            const programmerButtons = [
                { label: 'HEX', action: 'hex', class: 'btn-function', subLabel: 'Hexadecimal' },
                { label: 'DEC', action: 'dec', class: 'btn-function', subLabel: 'Decimal' },
                { label: 'OCT', action: 'oct', class: 'btn-function', subLabel: 'Octal' },
                { label: 'BIN', action: 'bin', class: 'btn-function', subLabel: 'Binary' },
                { label: 'AND', action: 'and', class: 'btn-function', subLabel: 'AND' },
                { label: 'OR', action: 'or', class: 'btn-function', subLabel: 'OR' },
                { label: 'XOR', action: 'xor', class: 'btn-function', subLabel: 'XOR' },
                { label: 'NOT', action: 'not', class: 'btn-function', subLabel: 'NOT' },
                { label: '<<', action: 'shiftLeft', class: 'btn-function', subLabel: 'Shift Left' },
                { label: '>>', action: 'shiftRight', class: 'btn-function', subLabel: 'Shift Right' },
                { label: 'ROL', action: 'rotateLeft', class: 'btn-function', subLabel: 'Rotate Left' },
                { label: 'ROR', action: 'rotateRight', class: 'btn-function', subLabel: 'Rotate Right' }
            ];

            // إنشاء الأزرار
            createButtons('calculator-grid', basicButtons);
            createButtons('scientific-grid', scientificButtons);
            createButtons('programmer-grid', programmerButtons);
        }

        function createButtons(containerId, buttons) {
            const container = document.querySelector(`.${containerId}`);
            container.innerHTML = '';
            
            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = `calc-btn ${button.class}`;
                btn.setAttribute('data-action', button.action);
                btn.innerHTML = `
                    ${button.label}
                    ${button.subLabel ? `<span class="btn-label">${button.subLabel}</span>` : ''}
                `;
                
                if (button.colSpan) {
                    btn.style.gridColumn = `span ${button.colSpan}`;
                }
                
                btn.addEventListener('click', () => handleCalculatorAction(button.action));
                container.appendChild(btn);
            });
        }

        function handleCalculatorAction(action) {
            playSound('click');
            
            if (['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'].includes(action)) {
                inputNumber(action);
            } else if (action === '.') {
                inputDecimal();
            } else if (['+', '-', '*', '/'].includes(action)) {
                setOperation(action);
            } else if (action === '=') {
                calculate();
            } else if (action === 'clear') {
                clearCalculator();
            } else if (action === 'backspace') {
                backspace();
            } else if (action === 'percentage') {
                percentage();
            } else if (action === 'toggleSign') {
                toggleSign();
            } else if (['sin', 'cos', 'tan', 'log', 'ln', 'sqrt', 'square', 'cube', 'cbrt', 'exp', 'factorial', 'abs', 'reciprocal'].includes(action)) {
                calculateFunction(action);
            } else if (action === 'pi') {
                inputConstant(Math.PI);
            } else if (action === 'euler') {
                inputConstant(Math.E);
            } else if (action === '(' || action === ')') {
                inputParenthesis(action);
            }
            
            updateDisplay();
        }

        function inputNumber(number) {
            if (calculatorState.waitingForNewValue) {
                calculatorState.currentValue = number;
                calculatorState.waitingForNewValue = false;
            } else {
                calculatorState.currentValue = calculatorState.currentValue === '0' ? number : calculatorState.currentValue + number;
            }
        }

        function inputDecimal() {
            if (!calculatorState.currentValue.includes('.')) {
                calculatorState.currentValue += '.';
            }
        }

        function setOperation(op) {
            if (calculatorState.operation !== null) {
                calculate();
            }
            calculatorState.previousValue = calculatorState.currentValue;
            calculatorState.operation = op;
            calculatorState.waitingForNewValue = true;
            updateExpressionDisplay();
        }

        function calculate() {
            if (calculatorState.operation === null || calculatorState.waitingForNewValue) {
                return;
            }

            const prev = parseFloat(calculatorState.previousValue);
            const current = parseFloat(calculatorState.currentValue);
            
            if (isNaN(prev) || isNaN(current)) return;

            let result;
            try {
                switch(calculatorState.operation) {
                    case '+':
                        result = prev + current;
                        break;
                    case '-':
                        result = prev - current;
                        break;
                    case '*':
                        result = prev * current;
                        break;
                    case '/':
                        if (current === 0) throw new Error('القسمة على صفر غير مسموحة');
                        result = prev / current;
                        break;
                }

                // إضافة للسجل
                addToHistory(`${prev} ${getOperationSymbol(calculatorState.operation)} ${current} = ${formatNumber(result)}`);
                
                calculatorState.currentValue = result.toString();
                calculatorState.operation = null;
                calculatorState.previousValue = '';
                calculatorState.waitingForNewValue = true;
                updateExpressionDisplay();
                updateCalculationTime();
                
                playSound('success');
                
            } catch (error) {
                showError(error.message);
                playSound('error');
            }
        }

        function calculateFunction(func) {
            const current = parseFloat(calculatorState.currentValue);
            if (isNaN(current)) return;

            let result;
            let operationStr;
            
            try {
                switch(func) {
                    case 'sin':
                        result = Math.sin(current * Math.PI / 180);
                        operationStr = `sin(${current})`;
                        break;
                    case 'cos':
                        result = Math.cos(current * Math.PI / 180);
                        operationStr = `cos(${current})`;
                        break;
                    case 'tan':
                        result = Math.tan(current * Math.PI / 180);
                        operationStr = `tan(${current})`;
                        break;
                    case 'log':
                        if (current <= 0) throw new Error('اللوغاريتم للأعداد الموجبة فقط');
                        result = Math.log10(current);
                        operationStr = `log(${current})`;
                        break;
                    case 'ln':
                        if (current <= 0) throw new Error('اللوغاريتم الطبيعي للأعداد الموجبة فقط');
                        result = Math.log(current);
                        operationStr = `ln(${current})`;
                        break;
                    case 'sqrt':
                        if (current < 0) throw new Error('الجذر التربيعي للأعداد غير السالبة فقط');
                        result = Math.sqrt(current);
                        operationStr = `√${current}`;
                        break;
                    case 'square':
                        result = current * current;
                        operationStr = `${current}²`;
                        break;
                    case 'cube':
                        result = current * current * current;
                        operationStr = `${current}³`;
                        break;
                    case 'cbrt':
                        result = Math.cbrt(current);
                        operationStr = `∛${current}`;
                        break;
                    case 'exp':
                        result = Math.exp(current);
                        operationStr = `e^${current}`;
                        break;
                    case 'factorial':
                        if (current < 0 || !Number.isInteger(current)) throw new Error('المضروب للأعداد الصحيحة الموجبة فقط');
                        result = factorial(current);
                        operationStr = `${current}!`;
                        break;
                    case 'abs':
                        result = Math.abs(current);
                        operationStr = `|${current}|`;
                        break;
                    case 'reciprocal':
                        if (current === 0) throw new Error('لا يمكن القسمة على صفر');
                        result = 1 / current;
                        operationStr = `1/${current}`;
                        break;
                }

                addToHistory(`${operationStr} = ${formatNumber(result)}`);
                calculatorState.currentValue = result.toString();
                updateCalculationTime();
                playSound('success');
                
            } catch (error) {
                showError(error.message);
                playSound('error');
            }
        }

        function clearCalculator() {
            calculatorState.currentValue = '0';
            calculatorState.previousValue = '';
            calculatorState.operation = null;
            calculatorState.waitingForNewValue = false;
            updateExpressionDisplay();
            playSound('clear');
        }

        function backspace() {
            if (calculatorState.currentValue.length > 1) {
                calculatorState.currentValue = calculatorState.currentValue.slice(0, -1);
            } else {
                calculatorState.currentValue = '0';
            }
        }

        function percentage() {
            const current = parseFloat(calculatorState.currentValue);
            if (!isNaN(current)) {
                calculatorState.currentValue = (current / 100).toString();
            }
        }

        function toggleSign() {
            if (calculatorState.currentValue !== '0') {
                calculatorState.currentValue = calculatorState.currentValue.startsWith('-') ? 
                    calculatorState.currentValue.slice(1) : '-' + calculatorState.currentValue;
            }
        }

        function inputConstant(constant) {
            calculatorState.currentValue = constant.toString();
        }

        function inputParenthesis(parenthesis) {
            calculatorState.currentValue += parenthesis;
        }

        function updateDisplay() {
            const display = document.getElementById('resultDisplay');
            const expressionDisplay = document.getElementById('expressionDisplay');
            
            display.textContent = formatNumber(calculatorState.currentValue);
            
            // تحديث مؤشر الذاكرة
            const memoryIndicator = document.getElementById('memoryIndicator');
            const memoryValue = document.getElementById('memoryValue');
            
            if (calculatorState.memory !== 0) {
                memoryIndicator.style.display = 'flex';
                memoryValue.textContent = formatNumber(calculatorState.memory);
            } else {
                memoryIndicator.style.display = 'none';
            }
        }

        function updateExpressionDisplay() {
            const expressionDisplay = document.getElementById('expressionDisplay');
            if (calculatorState.operation) {
                expressionDisplay.textContent = `${calculatorState.previousValue} ${getOperationSymbol(calculatorState.operation)}`;
            } else {
                expressionDisplay.textContent = '';
            }
        }

        function updateCalculationTime() {
            const timeElement = document.getElementById('calculationTime');
            const now = new Date();
            timeElement.textContent = now.toLocaleTimeString('ar-SA');
        }

        // ==================== محول الوحدات ====================
        function initConverter() {
            // وحدات التحويل
            const units = {
                length: {
                    meters: 1,
                    kilometers: 0.001,
                    centimeters: 100,
                    millimeters: 1000,
                    miles: 0.000621371,
                    yards: 1.09361,
                    feet: 3.28084,
                    inches: 39.3701
                },
                weight: {
                    kilograms: 1,
                    grams: 1000,
                    milligrams: 1000000,
                    pounds: 2.20462,
                    ounces: 35.274,
                    tons: 0.001
                },
                temperature: {
                    celsius: 'c',
                    fahrenheit: 'f',
                    kelvin: 'k'
                },
                currency: {
                    usd: 1,
                    eur: 0.85,
                    gbp: 0.73,
                    jpy: 110.5,
                    cny: 6.45,
                    sar: 3.75,
                    aed: 3.67,
                    egp: 15.7
                },
                area: {
                    squareMeters: 1,
                    squareKilometers: 0.000001,
                    squareMiles: 0.000000386,
                    acres: 0.000247,
                    hectares: 0.0001,
                    squareFeet: 10.7639
                },
                volume: {
                    liters: 1,
                    milliliters: 1000,
                    cubicMeters: 0.001,
                    gallons: 0.264172,
                    cubicFeet: 0.0353147,
                    cubicInches: 61.0237
                },
                time: {
                    seconds: 1,
                    minutes: 1/60,
                    hours: 1/3600,
                    days: 1/86400,
                    weeks: 1/604800,
                    months: 1/2.628e+6,
                    years: 1/3.154e+7
                },
                speed: {
                    metersPerSecond: 1,
                    kilometersPerHour: 3.6,
                    milesPerHour: 2.23694,
                    feetPerSecond: 3.28084,
                    knots: 1.94384
                }
            };

            // تهيئة محول الوحدات
            const converterTypes = document.querySelectorAll('.converter-type');
            const fromUnitSelect = document.getElementById('fromUnit');
            const toUnitSelect = document.getElementById('toUnit');
            const fromInput = document.getElementById('fromInput');
            const toInput = document.getElementById('toInput');
            const swapBtn = document.getElementById('swapUnits');

            let currentType = 'length';

            function loadUnits(type) {
                currentType = type;
                const unitList = Object.keys(units[type]);
                
                fromUnitSelect.innerHTML = '';
                toUnitSelect.innerHTML = '';
                
                unitList.forEach(unit => {
                    const fromOption = document.createElement('option');
                    const toOption = document.createElement('option');
                    
                    const displayName = getUnitDisplayName(unit, type);
                    
                    fromOption.value = unit;
                    fromOption.textContent = displayName;
                    
                    toOption.value = unit;
                    toOption.textContent = displayName;
                    
                    fromUnitSelect.appendChild(fromOption);
                    toUnitSelect.appendChild(toOption);
                });
                
                // تعيين القيم الافتراضية
                fromUnitSelect.selectedIndex = 0;
                toUnitSelect.selectedIndex = 1;
                
                convertUnits();
            }

            function getUnitDisplayName(unit, type) {
                const names = {
                    length: {
                        meters: 'متر',
                        kilometers: 'كيلومتر',
                        centimeters: 'سنتيمتر',
                        millimeters: 'ملليمتر',
                        miles: 'ميل',
                        yards: 'ياردة',
                        feet: 'قدم',
                        inches: 'بوصة'
                    },
                    weight: {
                        kilograms: 'كيلوغرام',
                        grams: 'غرام',
                        milligrams: 'ملليغرام',
                        pounds: 'رطل',
                        ounces: 'أونصة',
                        tons: 'طن'
                    },
                    temperature: {
                        celsius: 'مئوي',
                        fahrenheit: 'فهرنهايت',
                        kelvin: 'كلفن'
                    },
                    currency: {
                        usd: 'دولار أمريكي',
                        eur: 'يورو',
                        gbp: 'جنيه إسترليني',
                        jpy: 'ين ياباني',
                        cny: 'يوان صيني',
                        sar: 'ريال سعودي',
                        aed: 'درهم إماراتي',
                        egp: 'جنيه مصري'
                    }
                };
                
                return names[type]?.[unit] || unit;
            }

            function convertUnits() {
                const fromUnit = fromUnitSelect.value;
                const toUnit = toUnitSelect.value;
                const inputValue = parseFloat(fromInput.value) || 0;
                
                let result;
                
                if (currentType === 'temperature') {
                    result = convertTemperature(inputValue, fromUnit, toUnit);
                } else {
                    const factor = units[currentType][toUnit] / units[currentType][fromUnit];
                    result = inputValue * factor;
                }
                
                toInput.value = formatNumber(result);
            }

            function convertTemperature(value, from, to) {
                let celsius;
                
                // التحويل إلى مئوي أولاً
                switch(from) {
                    case 'celsius':
                        celsius = value;
                        break;
                    case 'fahrenheit':
                        celsius = (value - 32) * 5/9;
                        break;
                    case 'kelvin':
                        celsius = value - 273.15;
                        break;
                }
                
                // التحويل من مئوي إلى الوحدة المطلوبة
                switch(to) {
                    case 'celsius':
                        return celsius;
                    case 'fahrenheit':
                        return (celsius * 9/5) + 32;
                    case 'kelvin':
                        return celsius + 273.15;
                }
            }

            // أحداث المحول
            converterTypes.forEach(type => {
                type.addEventListener('click', () => {
                    converterTypes.forEach(t => t.classList.remove('active'));
                    type.classList.add('active');
                    loadUnits(type.dataset.type);
                });
            });

            fromUnitSelect.addEventListener('change', convertUnits);
            toUnitSelect.addEventListener('change', convertUnits);
            fromInput.addEventListener('input', convertUnits);
            swapBtn.addEventListener('click', () => {
                const tempUnit = fromUnitSelect.value;
                fromUnitSelect.value = toUnitSelect.value;
                toUnitSelect.value = tempUnit;
                convertUnits();
            });

            // تحميل الوحدات الأولية
            loadUnits('length');
        }

        // ==================== الرسوم البيانية ====================
        function initGraph() {
            const canvas = document.getElementById('graphCanvas');
            const ctx = canvas.getContext('2d');
            const functionInput = document.getElementById('functionInput');
            const xMinInput = document.getElementById('xMin');
            const xMaxInput = document.getElementById('xMax');
            const yMinInput = document.getElementById('yMin');
            const yMaxInput = document.getElementById('yMax');

            let isDrawing = false;
            let graphData = {
                function: 'sin(x)',
                xMin: -10,
                xMax: 10,
                yMin: -10,
                yMax: 10,
                points: []
            };

            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                drawGraph();
            }

            function drawGraph() {
                const width = canvas.width;
                const height = canvas.height;
                const padding = 40;
                const graphWidth = width - 2 * padding;
                const graphHeight = height - 2 * padding;

                // مسح الخلفية
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--light-card').trim();
                if (calculatorState.settings.darkMode) {
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--dark-card').trim();
                }
                ctx.fillRect(0, 0, width, height);

                // رسم المحاور
                ctx.strokeStyle = calculatorState.settings.darkMode ? '#444' : '#ccc';
                ctx.lineWidth = 2;

                // المحور X
                ctx.beginPath();
                ctx.moveTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();

                // المحور Y
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, height - padding);
                ctx.stroke();

                // إضافة الأسهم
                ctx.fillStyle = calculatorState.settings.darkMode ? '#888' : '#666';

                // سهم المحور X
                ctx.beginPath();
                ctx.moveTo(width - padding, height - padding);
                ctx.lineTo(width - padding - 10, height - padding - 5);
                ctx.lineTo(width - padding - 10, height - padding + 5);
                ctx.fill();

                // سهم المحور Y
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding - 5, padding + 10);
                ctx.lineTo(padding + 5, padding + 10);
                ctx.fill();

                // إضافة الترقيم
                ctx.fillStyle = calculatorState.settings.darkMode ? '#aaa' : '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';

                // ترقيم المحور X
                const xStep = (graphData.xMax - graphData.xMin) / 10;
                for (let i = 0; i <= 10; i++) {
                    const x = graphData.xMin + i * xStep;
                    const pixelX = padding + (i * graphWidth / 10);
                    
                    ctx.beginPath();
                    ctx.moveTo(pixelX, height - padding - 5);
                    ctx.lineTo(pixelX, height - padding + 5);
                    ctx.stroke();
                    
                    ctx.fillText(x.toFixed(1), pixelX, height - padding + 10);
                }

                // ترقيم المحور Y
                const yStep = (graphData.yMax - graphData.yMin) / 10;
                for (let i = 0; i <= 10; i++) {
                    const y = graphData.yMax - i * yStep;
                    const pixelY = padding + (i * graphHeight / 10);
                    
                    ctx.beginPath();
                    ctx.moveTo(padding - 5, pixelY);
                    ctx.lineTo(padding + 5, pixelY);
                    ctx.stroke();
                    
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(y.toFixed(1), padding - 10, pixelY);
                }

                // رسم المنحنيات
                const functions = graphData.function.split(',').map(f => f.trim());
                const colors = ['#4361ee', '#4cc9f0', '#f72585', '#2ecc71', '#f39c12'];

                functions.forEach((func, index) => {
                    const color = colors[index % colors.length];
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;
                    ctx.beginPath();

                    let firstPoint = true;
                    
                    for (let i = 0; i <= graphWidth; i++) {
                        const x = graphData.xMin + (i / graphWidth) * (graphData.xMax - graphData.xMin);
                        let y;
                        
                        try {
                            y = evaluateFunction(func, x);
                            
                            // التحقق من أن y ضمن الحدود
                            if (y < graphData.yMin || y > graphData.yMax || !isFinite(y)) {
                                firstPoint = true;
                                continue;
                            }
                            
                            const pixelX = padding + i;
                            const pixelY = padding + ((graphData.yMax - y) / (graphData.yMax - graphData.yMin)) * graphHeight;
                            
                            if (firstPoint) {
                                ctx.moveTo(pixelX, pixelY);
                                firstPoint = false;
                            } else {
                                ctx.lineTo(pixelX, pixelY);
                            }
                        } catch (error) {
                            firstPoint = true;
                        }
                    }
                    
                    ctx.stroke();
                });

                // إضافة وسيلة إيضاح
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                functions.forEach((func, index) => {
                    const color = colors[index % colors.length];
                    ctx.fillStyle = color;
                    ctx.fillRect(width - 150, 20 + index * 25, 20, 20);
                    ctx.fillStyle = calculatorState.settings.darkMode ? '#fff' : '#000';
                    ctx.fillText(func, width - 120, 35 + index * 25);
                });
            }

            function evaluateFunction(func, x) {
                // استبدال المتغيرات
                let expression = func.replace(/x/g, `(${x})`);
                
                // استبدال الدوال الرياضية
                expression = expression.replace(/sin\(/g, 'Math.sin(');
                expression = expression.replace(/cos\(/g, 'Math.cos(');
                expression = expression.replace(/tan\(/g, 'Math.tan(');
                expression = expression.replace(/log\(/g, 'Math.log10(');
                expression = expression.replace(/ln\(/g, 'Math.log(');
                expression = expression.replace(/sqrt\(/g, 'Math.sqrt(');
                expression = expression.replace(/abs\(/g, 'Math.abs(');
                expression = expression.replace(/exp\(/g, 'Math.exp(');
                expression = expression.replace(/pi/g, Math.PI.toString());
                expression = expression.replace(/e/g, Math.E.toString());
                
                try {
                    // استخدام Function لتقييم التعبير
                    return new Function('return ' + expression)();
                } catch (error) {
                    throw new Error('تعبير غير صالح');
                }
            }

            function updateGraph() {
                graphData.function = functionInput.value;
                graphData.xMin = parseFloat(xMinInput.value);
                graphData.xMax = parseFloat(xMaxInput.value);
                graphData.yMin = parseFloat(yMinInput.value);
                graphData.yMax = parseFloat(yMaxInput.value);
                
                drawGraph();
            }

            // أحداث الرسوم البيانية
            functionInput.addEventListener('input', updateGraph);
            xMinInput.addEventListener('input', updateGraph);
            xMaxInput.addEventListener('input', updateGraph);
            yMinInput.addEventListener('input', updateGraph);
            yMaxInput.addEventListener('input', updateGraph);

            // تكبير وتصغير بالماوس
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const width = canvas.width;
                const height = canvas.height;
                const padding = 40;
                const graphWidth = width - 2 * padding;
                const graphHeight = height - 2 * padding;
                
                const mouseX = graphData.xMin + ((x - padding) / graphWidth) * (graphData.xMax - graphData.xMin);
                const mouseY = graphData.yMax - ((y - padding) / graphHeight) * (graphData.yMax - graphData.yMin);
                
                const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
                
                graphData.xMin = mouseX - (mouseX - graphData.xMin) * zoomFactor;
                graphData.xMax = mouseX + (graphData.xMax - mouseX) * zoomFactor;
                graphData.yMin = mouseY - (mouseY - graphData.yMin) * zoomFactor;
                graphData.yMax = mouseY + (graphData.yMax - mouseY) * zoomFactor;
                
                xMinInput.value = graphData.xMin.toFixed(1);
                xMaxInput.value = graphData.xMax.toFixed(1);
                yMinInput.value = graphData.yMin.toFixed(1);
                yMaxInput.value = graphData.yMax.toFixed(1);
                
                drawGraph();
            });

            // السحب لنقل الرسم
            let isDragging = false;
            let lastX = 0;
            let lastY = 0;

            canvas.addEventListener('mousedown', function(e) {
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
            });

            canvas.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - lastX;
                const dy = e.clientY - lastY;
                
                const width = canvas.width;
                const height = canvas.height;
                const padding = 40;
                const graphWidth = width - 2 * padding;
                const graphHeight = height - 2 * padding;
                
                const xRange = graphData.xMax - graphData.xMin;
                const yRange = graphData.yMax - graphData.yMin;
                
                graphData.xMin -= (dx / graphWidth) * xRange;
                graphData.xMax -= (dx / graphWidth) * xRange;
                graphData.yMin += (dy / graphHeight) * yRange;
                graphData.yMax += (dy / graphHeight) * yRange;
                
                xMinInput.value = graphData.xMin.toFixed(1);
                xMaxInput.value = graphData.xMax.toFixed(1);
                yMinInput.value = graphData.yMin.toFixed(1);
                yMaxInput.value = graphData.yMax.toFixed(1);
                
                lastX = e.clientX;
                lastY = e.clientY;
                
                drawGraph();
            });

            canvas.addEventListener('mouseup', function() {
                isDragging = false;
            });

            canvas.addEventListener('mouseleave', function() {
                isDragging = false;
            });

            // التهيئة الأولية
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            updateGraph();
        }

        // ==================== الإعدادات ====================
        function initSettings() {
            // تحديث واجهة الإعدادات
            updateSettingsUI();
            
            // أحداث الإعدادات
            document.getElementById('darkModeToggle').addEventListener('change', function(e) {
                calculatorState.settings.darkMode = e.target.checked;
                saveSettings();
                applySettings();
            });
            
            document.getElementById('gradientBgToggle').addEventListener('change', function(e) {
                calculatorState.settings.gradientBg = e.target.checked;
                saveSettings();
                applySettings();
            });
            
            document.getElementById('primaryColorPicker').addEventListener('input', function(e) {
                calculatorState.settings.primaryColor = e.target.value;
                saveSettings();
                applySettings();
            });
            
            document.getElementById('fontSizeSlider').addEventListener('input', function(e) {
                const size = e.target.value;
                calculatorState.settings.fontSize = parseInt(size);
                document.getElementById('fontSizeValue').textContent = size + 'px';
                saveSettings();
                applySettings();
            });
            
            document.getElementById('soundToggle').addEventListener('change', function(e) {
                calculatorState.settings.soundEnabled = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('vibrationToggle').addEventListener('change', function(e) {
                calculatorState.settings.vibrationEnabled = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('autoFormatToggle').addEventListener('change', function(e) {
                calculatorState.settings.autoFormat = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('decimalSlider').addEventListener('input', function(e) {
                const decimals = e.target.value;
                calculatorState.settings.decimalPlaces = parseInt(decimals);
                document.getElementById('decimalValue').textContent = decimals;
                saveSettings();
            });
            
            document.getElementById('languageSelect').addEventListener('change', function(e) {
                calculatorState.settings.language = e.target.value;
                saveSettings();
                // هنا يمكن إضافة منطق تغيير اللغة
            });
            
            document.getElementById('backupBtn').addEventListener('click', backupSettings);
            document.getElementById('restoreBtn').addEventListener('click', restoreSettings);
            document.getElementById('resetBtn').addEventListener('click', resetSettings);
        }

        function updateSettingsUI() {
            document.getElementById('darkModeToggle').checked = calculatorState.settings.darkMode;
            document.getElementById('gradientBgToggle').checked = calculatorState.settings.gradientBg;
            document.getElementById('primaryColorPicker').value = calculatorState.settings.primaryColor;
            document.getElementById('fontSizeSlider').value = calculatorState.settings.fontSize;
            document.getElementById('fontSizeValue').textContent = calculatorState.settings.fontSize + 'px';
            document.getElementById('soundToggle').checked = calculatorState.settings.soundEnabled;
            document.getElementById('vibrationToggle').checked = calculatorState.settings.vibrationEnabled;
            document.getElementById('autoFormatToggle').checked = calculatorState.settings.autoFormat;
            document.getElementById('decimalSlider').value = calculatorState.settings.decimalPlaces;
            document.getElementById('decimalValue').textContent = calculatorState.settings.decimalPlaces;
            document.getElementById('languageSelect').value = calculatorState.settings.language;
        }

        function applySettings() {
            // تطبيق السمة الداكنة
            if (calculatorState.settings.darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-moon';
            }
            
            // تطبيق الخلفية المتدرجة
            if (calculatorState.settings.gradientBg) {
                document.body.classList.add('gradient-bg');
            } else {
                document.body.classList.remove('gradient-bg');
            }
            
            // تطبيق اللون الرئيسي
            document.documentElement.style.setProperty('--primary-color', calculatorState.settings.primaryColor);
            
            // تطبيق حجم الخط
            document.documentElement.style.fontSize = calculatorState.settings.fontSize + 'px';
        }

        function saveSettings() {
            localStorage.setItem('calculatorProSettings', JSON.stringify(calculatorState.settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('calculatorProSettings');
            if (saved) {
                calculatorState.settings = { ...calculatorState.settings, ...JSON.parse(saved) };
            }
            applySettings();
        }

        function backupSettings() {
            const data = {
                settings: calculatorState.settings,
                history: calculatorState.history,
                memory: calculatorState.memory
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'calculator-pro-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('نجاح', 'تم إنشاء نسخة احتياطية', 'success');
        }

        function restoreSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (confirm('هل تريد استعادة النسخة الاحتياطية؟ سيتم فقدان الإعدادات الحالية.')) {
                            calculatorState.settings = data.settings || calculatorState.settings;
                            calculatorState.history = data.history || calculatorState.history;
                            calculatorState.memory = data.memory || calculatorState.memory;
                            
                            saveSettings();
                            updateSettingsUI();
                            applySettings();
                            loadHistory();
                            updateDisplay();
                            
                            showNotification('نجاح', 'تم استعادة النسخة الاحتياطية', 'success');
                        }
                    } catch (error) {
                        showNotification('خطأ', 'فشل في استعادة النسخة الاحتياطية', 'warning');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function resetSettings() {
            if (confirm('هل تريد إعادة ضبط جميع الإعدادات؟ سيتم فقدان كل الإعدادات والبيانات.')) {
                calculatorState.settings = {
                    darkMode: false,
                    gradientBg: false,
                    primaryColor: '#4361ee',
                    soundEnabled: true,
                    vibrationEnabled: false,
                    autoFormat: true,
                    decimalPlaces: 2,
                    language: 'ar',
                    fontSize: 16
                };
                
                calculatorState.history = [];
                calculatorState.memory = 0;
                
                saveSettings();
                updateSettingsUI();
                applySettings();
                loadHistory();
                updateDisplay();
                
                showNotification('نجاح', 'تم إعادة ضبط الإعدادات', 'success');
            }
        }

        // ==================== دوال مساعدة ====================
        function formatNumber(num) {
            if (!calculatorState.settings.autoFormat) {
                return num.toString();
            }
            
            const number = parseFloat(num);
            if (isNaN(number)) return num;
            
            // التعامل مع الأرقام الكبيرة جداً أو الصغيرة جداً
            if (Math.abs(number) > 1e12 || (Math.abs(number) < 1e-6 && number !== 0)) {
                return number.toExponential(calculatorState.settings.decimalPlaces);
            }
            
            // تنسيق الأرقام العادية
            return number.toLocaleString('ar-SA', {
                minimumFractionDigits: 0,
                maximumFractionDigits: calculatorState.settings.decimalPlaces
            });
        }

        function getOperationSymbol(op) {
            const symbols = {
                '+': '+',
                '-': '−',
                '*': '×',
                '/': '÷'
            };
            return symbols[op] || op;
        }

        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function addToHistory(entry) {
            calculatorState.history.unshift({
                operation: entry,
                timestamp: new Date().toISOString()
            });
            
            if (calculatorState.history.length > 50) {
                calculatorState.history.pop();
            }
            
            localStorage.setItem('calculatorProHistory', JSON.stringify(calculatorState.history));
        }

        function loadHistory() {
            const saved = localStorage.getItem('calculatorProHistory');
            if (saved) {
                calculatorState.history = JSON.parse(saved);
            }
        }

        function playSound(type) {
            if (!calculatorState.settings.soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === 'click') {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
                
            } else if (type === 'success') {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
            } else if (type === 'error') {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime); // F4
                oscillator.frequency.setValueAtTime(311.13, audioContext.currentTime + 0.1); // D#4
                oscillator.frequency.setValueAtTime(277.18, audioContext.currentTime + 0.2); // C#4
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'clear') {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(100, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
                oscillator.type = 'triangle';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }

        function vibrate() {
            if (calculatorState.settings.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function showError(message) {
            calculatorState.currentValue = 'خطأ!';
            updateDisplay();
            
            showNotification('خطأ', message, 'warning');
            
            setTimeout(() => {
                clearCalculator();
            }, 2000);
        }

        function showNotification(title, message, type) {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const notificationIcon = notification.querySelector('.notification-icon i');
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            notification.className = `notification notification-${type}`;
            notificationIcon.className = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            }[type];
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function closeNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        // ==================== إدارة الأقسام ====================
        function switchSection(sectionId) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.calculator-section, .converter-section, .graph-section, .settings-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // إلغاء تفعيل جميع أزرار التنقل
            document.querySelectorAll('.nav-btn, .mobile-menu-item').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار القسم المطلوب
            document.getElementById(sectionId + 'Section').classList.add('active');
            
            // تفعيل الزر المناسب
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            
            // تحديث عنوان الصفحة
            document.title = getSectionTitle(sectionId) + ' - حاسبة Pro';
            
            // إغلاق القائمة الجانبية للموبايل
            closeMobileMenu();
        }

        function getSectionTitle(sectionId) {
            const titles = {
                calculator: 'آلة حاسبة',
                converter: 'محول الوحدات',
                graph: 'الرسوم البيانية',
                settings: 'الإعدادات'
            };
            return titles[sectionId] || 'حاسبة Pro';
        }

        // ==================== إدارة النوافذ المنبثقة ====================
        function showHistoryModal() {
            const modal = document.getElementById('historyModal');
            const modalBody = document.getElementById('historyModalBody');
            
            modalBody.innerHTML = '';
            
            if (calculatorState.history.length === 0) {
                modalBody.innerHTML = '<p style="text-align: center; color: #666;">لا توجد عمليات سابقة</p>';
            } else {
                calculatorState.history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="history-expression">${item.operation}</div>
                        <div class="history-time">${new Date(item.timestamp).toLocaleString('ar-SA')}</div>
                    `;
                    
                    historyItem.addEventListener('click', () => {
                        const result = item.operation.split('=')[1]?.trim();
                        if (result) {
                            calculatorState.currentValue = result.replace(/[^\d.-]/g, '');
                            updateDisplay();
                            modal.classList.remove('active');
                        }
                    });
                    
                    modalBody.appendChild(historyItem);
                });
            }
            
            modal.classList.add('active');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        function showHelpModal() {
            const modal = document.getElementById('helpModal');
            const modalBody = document.getElementById('helpModalBody');
            
            modalBody.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 25px;">
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;">الآلة الحاسبة</h4>
                        <ul style="padding-right: 20px;">
                            <li>استخدم الأزرار أو لوحة المفاتيح لإدخال الأرقام</li>
                            <li>اضغط على = لحساب النتيجة</li>
                            <li>استخدم C لمسح المدخل الحالي</li>
                            <li>استخدم ⌫ لحذف آخر رقم</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;">محول الوحدات</h4>
                        <ul style="padding-right: 20px;">
                            <li>اختر نوع الوحدات من القائمة العلوية</li>
                            <li>حدد الوحدات المراد التحويل منها وإليها</li>
                            <li>أدخل القيمة المراد تحويلها</li>
                            <li>استخدم زر التبديل لتبديل الوحدات</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;">الرسوم البيانية</h4>
                        <ul style="padding-right: 20px;">
                            <li>أدخل الدالة الرياضية (استخدم x كمتغير)</li>
                            <li>اضبط حدود المحاور حسب الحاجة</li>
                            <li>استخدم عجلة الماوس للتكبير والتصغير</li>
                            <li>اسحب الرسم البياني لتحريكه</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;">اختصارات لوحة المفاتيح</h4>
                        <ul style="padding-right: 20px;">
                            <li>الأرقام: 0-9</li>
                            <li>العمليات: + - * /</li>
                            <li>النتيجة: Enter أو =</li>
                            <li>المسح: Escape أو Delete</li>
                            <li>التراجع: Backspace</li>
                        </ul>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // ==================== القائمة الجانبية للموبايل ====================
        function openMobileMenu() {
            document.getElementById('mobileMenu').classList.add('active');
            document.getElementById('mobileMenuOverlay').classList.add('active');
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('active');
            document.getElementById('mobileMenuOverlay').classList.remove('active');
        }

        // ==================== إعداد المستمعين للأحداث ====================
        function setupEventListeners() {
            // التنقل بين الأقسام
            document.querySelectorAll('.nav-btn, .mobile-menu-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchSection(this.dataset.section);
                });
            });
            
            // تبديل السمة
            document.getElementById('themeToggle').addEventListener('click', function() {
                calculatorState.settings.darkMode = !calculatorState.settings.darkMode;
                saveSettings();
                applySettings();
            });
            
            // النوافذ المنبثقة
            document.getElementById('historyBtn').addEventListener('click', showHistoryModal);
            document.getElementById('helpBtn').addEventListener('click', showHelpModal);
            
            // إغلاق النوافذ بالنقر خارجها
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // القائمة الجانبية للموبايل
            document.getElementById('mobileMenuBtn').addEventListener('click', openMobileMenu);
            document.getElementById('mobileMenuClose').addEventListener('click', closeMobileMenu);
            document.getElementById('mobileMenuOverlay').addEventListener('click', closeMobileMenu);
            
            // أوضاع الآلة الحاسبة
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const mode = this.dataset.mode;
                    calculatorState.currentMode = mode;
                    
                    // إظهار/إخفاء الأزرار حسب الوضع
                    document.querySelectorAll('.buttons-grid').forEach(grid => grid.classList.remove('active'));
                    
                    if (mode === 'basic') {
                        document.querySelector('.calculator-grid').classList.add('active');
                    } else if (mode === 'scientific') {
                        document.querySelector('.scientific-grid').classList.add('active');
                    } else if (mode === 'programmer') {
                        document.querySelector('.programmer-grid').classList.add('active');
                    }
                });
            });
            
            // تبويبات الأزرار
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    calculatorState.currentTab = this.dataset.tab;
                    
                    // هنا يمكن إضافة منطق لتبديل مجموعات الأزرار
                });
            });
            
            // شريط التقدم (محاكاة)
            window.addEventListener('scroll', function() {
                const progressBar = document.getElementById('progressBar');
                const windowHeight = document.documentElement.scrollHeight - window.innerHeight;
                const scrolled = (window.scrollY / windowHeight) * 100;
                progressBar.style.width = scrolled + '%';
            });
            
            // دعم لوحة المفاتيح للآلة الحاسبة
            document.addEventListener('keydown', function(e) {
                // فقط عندما تكون الآلة الحاسبة نشطة
                if (!document.getElementById('calculatorSection').classList.contains('active')) return;
                
                e.preventDefault();
                
                if (e.key >= '0' && e.key <= '9') {
                    inputNumber(e.key);
                    updateDisplay();
                } else if (e.key === '.') {
                    inputDecimal();
                    updateDisplay();
                } else if (['+', '-', '*', '/'].includes(e.key)) {
                    setOperation(e.key);
                    updateDisplay();
                } else if (e.key === 'Enter' || e.key === '=') {
                    calculate();
                    updateDisplay();
                } else if (e.key === 'Escape' || e.key === 'Delete') {
                    clearCalculator();
                    updateDisplay();
                } else if (e.key === 'Backspace') {
                    backspace();
                    updateDisplay();
                } else if (e.key === '%') {
                    percentage();
                    updateDisplay();
                } else if (e.key.toLowerCase() === 'p' && e.ctrlKey) {
                    calculatorState.settings.soundEnabled = !calculatorState.settings.soundEnabled;
                    showNotification('الصوت', `الصوت ${calculatorState.settings.soundEnabled ? 'مفعّل' : 'معطّل'}`, 'info');
                    saveSettings();
                }
            });
            
            // المساعدة باللمس للهواتف
            if ('ontouchstart' in window) {
                document.querySelectorAll('.calc-btn').forEach(btn => {
                    btn.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.95)';
                    });
                    
                    btn.addEventListener('touchend', function() {
                        this.style.transform = '';
                    });
                });
            }
            
            // منع الإغلاق المفاجئ
            window.addEventListener('beforeunload', function(e) {
                if (calculatorState.history.length > 0 || calculatorState.memory !== 0) {
                    e.preventDefault();
                    e.returnValue = 'لديك بيانات غير محفوظة. هل تريد المغادرة؟';
                }
            });
        }

        // ==================== دوال الصفحة الرئيسية ====================
        function showAbout() {
            showNotification('عن التطبيق', 'آلة حاسبة Pro - الإصدار 3.0\nتطبيق متكامل للحسابات العلمية والمتقدمة', 'info');
        }

        function showPrivacy() {
            const modal = document.getElementById('helpModal');
            const modalBody = document.getElementById('helpModalBody');
            
            modalBody.innerHTML = `
                <div>
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">سياسة الخصوصية</h4>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        نحن نحترم خصوصيتك. جميع البيانات التي تدخلها في التطبيق (الحسابات، التاريخ، الإعدادات) تخزن محلياً على جهازك فقط ولا يتم إرسالها إلى أي خادم خارجي.
                    </p>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        يمكنك في أي وقت:
                    </p>
                    <ul style="padding-right: 20px; margin-bottom: 15px;">
                        <li>مسح السجل من قسم التاريخ</li>
                        <li>إعادة ضبط الإعدادات من قسم الإعدادات</li>
                        <li>إنشاء نسخة احتياطية من بياناتك</li>
                    </ul>
                    <p style="line-height: 1.6;">
                        التطبيق لا يجمع أي معلومات شخصية ولا يتطلب أي أذونات خاصة.
                    </p>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function showTerms() {
            const modal = document.getElementById('helpModal');
            const modalBody = document.getElementById('helpModalBody');
            
            modalBody.innerHTML = `
                <div>
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">الشروط والأحكام</h4>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        باستخدامك هذا التطبيق، فإنك توافق على الشروط التالية:
                    </p>
                    <ul style="padding-right: 20px; margin-bottom: 15px;">
                        <li>التطبيق مقدم "كما هو" دون أي ضمانات</li>
                        <li>أنت المسؤول عن دقة الحسابات والنتائج</li>
                        <li>التطبيق للاستخدام الشخصي فقط</li>
                        <li>يحق لنا تحديث التطبيق في أي وقت</li>
                    </ul>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        تحذير: لا تستخدم هذا التطبيق للحسابات المالية أو الطبية الحرجة دون التحقق من النتائج من مصدر موثوق.
                    </p>
                    <p style="line-height: 1.6;">
                        للاستفسارات أو المشاكل التقنية، يرجى مراجعة قسم المساعدة.
                    </p>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function showFeedback() {
            showNotification('تقييم التطبيق', 'شكراً لاستخدامك تطبيقنا!\nسيتم إضافة نظام التقييم في تحديث قادم.', 'info');
        }

        // ==================== PWA Support ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // ==================== Install Prompt ====================
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // يمكن إضافة زر تثبيت التطبيق هنا
            setTimeout(() => {
                if (confirm('هل تريد تثبيت التطبيق على جهازك؟')) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            showNotification('تم التثبيت', 'تم تثبيت التطبيق بنجاح', 'success');
                        }
                        deferredPrompt = null;
                    });
                }
            }, 5000);
        });
    </script>
</body>
</html>